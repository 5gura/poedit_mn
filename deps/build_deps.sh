#!/bin/sh

set -e

mkdir -p "$DEPS_BUILD_DIR"
if [ ! -d "$DEPS_BUILD_DIR" ] ; then
    echo "build directory '$DEPS_BUILD_DIR' doesn't exist"
    exit 1
fi

if [ "$2" = clean ] ; then
    if [ ! -z "$DEPS_BUILD_DIR" ] ; then
        rm -rf "$DEPS_BUILD_DIR"/*
    fi
    exit
fi

# Include Homebrew binaries on PATH if not there yet:
PATH="$PATH:/opt/homebrew/bin:/usr/local/bin"

# Fake Java binaries so that gettext configure script doesn't invoke the system ones:
mkdir -p "$DEPS_BUILD_DIR/helpers"
touch "$DEPS_BUILD_DIR"/helpers/{java,javac}
chmod +x "$DEPS_BUILD_DIR"/helpers/{java,javac}
PATH="$DEPS_BUILD_DIR/helpers:$PATH"

if [ -f /opt/homebrew/bin/gsed ] ; then
    GSED=/opt/homebrew/bin/gsed
else
    GSED=/usr/local/bin/gsed
fi

if [ -f /opt/homebrew/opt/bison/bin/yacc ] ; then
    YACC=/opt/homebrew/opt/bison/bin/yacc
else
    YACC=/usr/local/opt/bison/bin/yacc
fi

if [ -f /opt/homebrew/opt/curl/bin/curl ] ; then
    CURL=/opt/homebrew/opt/curl/bin/curl
elif [ -f /usr/local/opt/curl/bin/curl ] ; then
    CURL=/usr/local/opt/curl/bin/curl
else
    CURL=curl
fi

if [ -d /opt/homebrew/opt/ccache/libexec ] ; then
    CC=/opt/homebrew/opt/ccache/libexec/clang
    CXX=/opt/homebrew/opt/ccache/libexec/clang++
elif [ -d /usr/local/opt/ccache/libexec ] ; then
    CC=/usr/local/opt/ccache/libexec/clang
    CXX=/usr/local/opt/ccache/libexec/clang++
else
    CC=clang
    CXX=clang++
fi

if [ "$CONFIGURATION" = "Debug" ] ; then
    cflags_config="-O2 -ggdb3"
    ldflags_config="-O2 -ggdb3"
else
    cflags_config="-O2"
    ldflags_config=""
fi

# don't produce error if the build is stopped for other reasons
trap "exit 0" INT

xcode_ninja_file="$DEPS_BUILD_DIR/xcode-$$.ninja"
trap "rm -f $xcode_ninja_file" EXIT

for ARCH in $ARCHS; do
    cat <<EOT >$xcode_ninja_file
# Generated by Xcode on `date`

SDKROOT = $SDKROOT
MACOSX_DEPLOYMENT_TARGET = $MACOSX_DEPLOYMENT_TARGET
CONFIGURATION = $CONFIGURATION

sed = $GSED
yacc = $YACC
curl = $CURL

arch = $ARCH
top_srcdir = `pwd`
builddir = $DEPS_BUILD_DIR

cc = $CC
cxx = $CXX

cflags_config = $cflags_config
ldflags_config = $ldflags_config

include build.ninja
EOT
    ninja -f $xcode_ninja_file $1
done

../macos/merge-archs.sh "$DEPS_BUILD_DIR/$1"
